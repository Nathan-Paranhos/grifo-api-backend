<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth - Obter Token para Testes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .auth-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .instructions {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Firebase Authentication</h1>
            <p>Obtenha um token Firebase para testar a API Grifo</p>
        </div>

        <div class="instructions">
            <h3>üìã Instru√ß√µes:</h3>
            <ol>
                <li>Configure as credenciais Firebase no script abaixo</li>
                <li>Fa√ßa login com uma conta autorizada</li>
                <li>Copie o token gerado</li>
                <li>Use o token no script PowerShell de teste</li>
            </ol>
        </div>

        <div class="auth-section">
            <h3>üîß Configura√ß√£o Firebase</h3>
            <div class="status info">
                <strong>‚ö†Ô∏è Importante:</strong> Substitua as configura√ß√µes abaixo pelas do seu projeto Firebase.
            </div>
            <textarea id="firebaseConfig" rows="10" style="width: 100%; font-family: monospace;">
// Configura√ß√£o do projeto Firebase Grifo (j√° configurado)
const firebaseConfig = {
  apiKey: "AIzaSyDRj2kodgFUW2-N1Boa5nP5IZYVg-HaJME",
  authDomain: "grifo-vistorias.firebaseapp.com",
  projectId: "grifo-vistorias",
  storageBucket: "grifo-vistorias.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};
            </textarea>
        </div>

        <div class="auth-section">
            <h3>üîë Login</h3>
            <div id="loginForm">
                <input type="email" id="email" placeholder="Email" value="">
                <input type="password" id="password" placeholder="Senha" value="">
                <br>
                <button class="btn" onclick="signInWithEmail()">Login com Email/Senha</button>
                <button class="btn" onclick="signInWithGoogle()">Login com Google</button>
            </div>
            
            <div id="userInfo" style="display: none;">
                <div class="status success">
                    <strong>‚úÖ Usu√°rio logado:</strong> <span id="userEmail"></span>
                </div>
                <button class="btn" onclick="getIdToken()">Obter Token</button>
                <button class="btn" onclick="signOut()">Logout</button>
            </div>
        </div>

        <div class="auth-section">
            <h3>üé´ Token Firebase</h3>
            <div id="tokenSection">
                <div class="status info">
                    O token aparecer√° aqui ap√≥s o login bem-sucedido.
                </div>
                <div id="tokenDisplay" class="token-display" style="display: none;">
                    <strong>Token ID:</strong><br>
                    <span id="tokenValue"></span>
                </div>
                <button class="btn" id="copyTokenBtn" onclick="copyToken()" style="display: none;">Copiar Token</button>
            </div>
        </div>

        <div class="auth-section">
            <h3>üß™ Teste da API</h3>
            <div id="apiTestSection">
                <button class="btn" onclick="testApiWithToken()" id="testApiBtn" disabled>Testar API com Token</button>
                <div id="apiResult"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // CONFIGURE AQUI AS CREDENCIAIS DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            // Configura√ß√µes do projeto Firebase Grifo (produ√ß√£o)
            apiKey: "AIzaSyDRj2kodgFUW2-N1Boa5nP5IZYVg-HaJME",
            authDomain: "grifo-vistorias.firebaseapp.com",
            projectId: "grifo-vistorias",
            storageBucket: "grifo-vistorias.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentToken = null;

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI();
        });

        function updateUI() {
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            const testApiBtn = document.getElementById('testApiBtn');

            if (currentUser) {
                loginForm.style.display = 'none';
                userInfo.style.display = 'block';
                userEmail.textContent = currentUser.email;
                testApiBtn.disabled = false;
                
                // Automatically get token when user logs in
                getIdToken();
            } else {
                loginForm.style.display = 'block';
                userInfo.style.display = 'none';
                testApiBtn.disabled = true;
                hideToken();
            }
        }

        // Make functions global
        window.signInWithEmail = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showStatus('Por favor, preencha email e senha.', 'error');
                return;
            }

            try {
                showStatus('Fazendo login...', 'info');
                await signInWithEmailAndPassword(auth, email, password);
                showStatus('Login realizado com sucesso!', 'success');
            } catch (error) {
                showStatus(`Erro no login: ${error.message}`, 'error');
            }
        };

        window.signInWithGoogle = async function() {
            try {
                showStatus('Abrindo popup do Google...', 'info');
                await signInWithPopup(auth, provider);
                showStatus('Login com Google realizado com sucesso!', 'success');
            } catch (error) {
                showStatus(`Erro no login com Google: ${error.message}`, 'error');
            }
        };

        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
                showStatus('Logout realizado com sucesso!', 'success');
            } catch (error) {
                showStatus(`Erro no logout: ${error.message}`, 'error');
            }
        };

        window.getIdToken = async function() {
            if (!currentUser) {
                showStatus('Usu√°rio n√£o est√° logado.', 'error');
                return;
            }

            try {
                showStatus('Obtendo token...', 'info');
                currentToken = await currentUser.getIdToken();
                showToken(currentToken);
                showStatus('Token obtido com sucesso!', 'success');
            } catch (error) {
                showStatus(`Erro ao obter token: ${error.message}`, 'error');
            }
        };

        window.copyToken = function() {
            if (currentToken) {
                navigator.clipboard.writeText(currentToken).then(() => {
                    showStatus('Token copiado para a √°rea de transfer√™ncia!', 'success');
                }).catch(() => {
                    showStatus('Erro ao copiar token. Copie manualmente.', 'error');
                });
            }
        };

        window.testApiWithToken = async function() {
            if (!currentToken) {
                showStatus('Token n√£o dispon√≠vel. Fa√ßa login primeiro.', 'error');
                return;
            }

            const apiResult = document.getElementById('apiResult');
            apiResult.innerHTML = '<div class="status info">Testando API...</div>';

            try {
                const response = await fetch('https://grifo-api.onrender.com/api/v1/properties', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    apiResult.innerHTML = `
                        <div class="status success">
                            <strong>‚úÖ API funcionando!</strong><br>
                            Status: ${response.status}<br>
                            Dados recebidos: ${data.data ? data.data.length : 0} registros
                        </div>
                        <div class="token-display">
                            <strong>Resposta da API:</strong><br>
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    apiResult.innerHTML = `
                        <div class="status error">
                            <strong>‚ùå Erro na API:</strong><br>
                            Status: ${response.status}<br>
                            Erro: ${data.error || 'Erro desconhecido'}
                        </div>
                    `;
                }
            } catch (error) {
                apiResult.innerHTML = `
                    <div class="status error">
                        <strong>‚ùå Erro de conex√£o:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        };

        function showToken(token) {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenValue = document.getElementById('tokenValue');
            const copyTokenBtn = document.getElementById('copyTokenBtn');

            tokenValue.textContent = token;
            tokenDisplay.style.display = 'block';
            copyTokenBtn.style.display = 'inline-block';
        }

        function hideToken() {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const copyTokenBtn = document.getElementById('copyTokenBtn');
            
            tokenDisplay.style.display = 'none';
            copyTokenBtn.style.display = 'none';
            currentToken = null;
        }

        function showStatus(message, type) {
            // Remove existing status messages
            const existingStatus = document.querySelectorAll('.status');
            existingStatus.forEach(status => {
                if (status.textContent.includes('Fazendo login') || 
                    status.textContent.includes('Obtendo token') ||
                    status.textContent.includes('Login realizado') ||
                    status.textContent.includes('Token obtido') ||
                    status.textContent.includes('Logout realizado') ||
                    status.textContent.includes('Token copiado') ||
                    status.textContent.includes('Erro')) {
                    status.remove();
                }
            });

            // Add new status message
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            const authSection = document.querySelector('.auth-section');
            authSection.appendChild(statusDiv);

            // Auto-remove success/info messages after 3 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>